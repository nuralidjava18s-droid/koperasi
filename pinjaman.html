<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pinjaman & Angsuran</title>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9;}
header{background:#1e90ff;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;}
header button{background:#ff5252;border:none;color:white;padding:6px 10px;border-radius:5px;}
.container{padding:20px;}
.tabs{display:flex;gap:10px;margin-bottom:20px;}
.tabs button{flex:1;padding:10px;border:none;border-radius:5px;background:#ddd;}
.tabs button.active{background:#1e90ff;color:white;}
.tabcontent{display:none;}
form,table{background:white;padding:15px;border-radius:8px;margin-bottom:20px;}
form select,form input{width:100%;padding:8px;margin:5px 0;}
table{border-collapse:collapse;width:100%;}
th,td{padding:10px;border:1px solid #ddd;text-align:center;}
th{background:#eee;}
</style>
</head>

<body>

<header>
<h3>ðŸ“Œ Pinjaman & Angsuran</h3>
<div>
<button onclick="location.href='dashboard.html'">â¬… Dashboard</button>
<button onclick="logout()">Logout</button>
</div>
</header>

<div class="container">

<div class="tabs">
<button class="tablink active" onclick="openTab(event,'pinjaman')">Pinjaman</button>
<button class="tablink" onclick="openTab(event,'bayar')">Bayar Angsuran</button>
</div>

<!-- PINJAMAN -->
<div id="pinjaman" class="tabcontent" style="display:block">
<form id="formPinjaman" onsubmit="simpanPinjaman(event)">
<h4>ðŸ“Œ Tambah Pinjaman</h4>
<select id="anggotaPinjam" required></select>
<input type="number" id="jumlahPinjam" placeholder="Jumlah Pinjaman" required>
<input type="number" id="bungaPinjam" placeholder="Bunga % / bulan" required>
<input type="number" id="tenorPinjam" placeholder="Tenor (bulan)" required>
<input type="text" id="angsuranPinjam" readonly placeholder="Angsuran / bulan">
<button type="submit">ðŸ’¾ Simpan</button>
</form>

<table>
<thead>
<tr>
<th>Anggota</th><th>Total</th><th>Bunga</th><th>Tenor</th><th>Sisa</th><th>Status</th>
</tr>
</thead>
<tbody id="listPinjaman"></tbody>
</table>
</div>

<!-- BAYAR -->
<div id="bayar" class="tabcontent">
<form id="formBayar" onsubmit="simpanAngsuran(event)">
<select id="anggotaBayar" onchange="loadPinjamanDropdown()" required></select>
<select id="pinjamanBayar" required></select>
<input type="number" id="jumlahBayar" placeholder="Jumlah Bayar" required>
<button type="submit">ðŸ’¾ Simpan</button>
</form>

<table>
<thead>
<tr><th>Anggota</th><th>Bayar</th><th>Tanggal</th></tr>
</thead>
<tbody id="listBayar"></tbody>
</table>
</div>

</div>

<script src="js/storage.js"></script>
<script src="js/auth.js"></script>
<script>
cekLogin();

/* TAB */
function openTab(e,id){
document.querySelectorAll('.tabcontent').forEach(t=>t.style.display='none');
document.querySelectorAll('.tablink').forEach(b=>b.classList.remove('active'));
document.getElementById(id).style.display='block';
e.currentTarget.classList.add('active');
}

function rupiah(n){return "Rp "+Number(n||0).toLocaleString("id-ID");}
function logout(){localStorage.removeItem("login");location.href="login.html";}

/* LOAD ANGGOTA */
function loadAnggota(){
const db=getDB();
['anggotaPinjam','anggotaBayar'].forEach(id=>{
const sel=document.getElementById(id);
sel.innerHTML='<option value="">-- Pilih Anggota --</option>';
(db.anggota||[]).forEach(a=>{
sel.innerHTML+=`<option value="${a.id}">${a.nama}</option>`;
});
});
}

/* HITUNG ANGSURAN */
['jumlahPinjam','bungaPinjam','tenorPinjam'].forEach(id=>{
document.getElementById(id).addEventListener("input",()=>{
const j=+jumlahPinjam.value||0;
const b=+bungaPinjam.value||0;
const t=+tenorPinjam.value||0;
if(j&&b&&t){
angsuranPinjam.value=rupiah(Math.ceil((j+j*b*t/100)/t));
}else angsuranPinjam.value="";
});
});

/* SIMPAN PINJAMAN */
function simpanPinjaman(e){
e.preventDefault();
const db=getDB();
db.pinjaman=db.pinjaman||[];

const anggota_id=anggotaPinjam.value;
const jumlah=+jumlahPinjam.value;
const bunga=+bungaPinjam.value;
const tenor=+tenorPinjam.value;

const total=jumlah+(jumlah*bunga*tenor/100);

db.pinjaman.push({
id:Date.now(),
anggota_id,
jumlah,
bunga,
tenor,
total,
sisa:total,
tanggal:new Date().toISOString().slice(0,10)
});

saveDB(db);
formPinjaman.reset();
loadPinjaman();
alert("Pinjaman tersimpan");
}

/* LOAD PINJAMAN */
function loadPinjaman(){
const db=getDB();
db.transaksi=db.transaksi||[];
listPinjaman.innerHTML="";
(db.pinjaman||[]).forEach(p=>{
const a=db.anggota.find(x=>x.id===p.anggota_id);
const status=p.sisa<=0?"LUNAS":"BELUM";
listPinjaman.innerHTML+=`
<tr>
<td>${a?a.nama:"-"}</td>
<td>${rupiah(p.total)}</td>
<td>${p.bunga}%</td>
<td>${p.tenor}</td>
<td>${rupiah(p.sisa)}</td>
<td>${status}</td>
</tr>`;
});
}

/* DROPDOWN BAYAR */
function loadPinjamanDropdown(){
const db=getDB();
pinjamanBayar.innerHTML='<option value="">-- Pilih Pinjaman --</option>';
(db.pinjaman||[]).filter(p=>p.anggota_id===anggotaBayar.value&&p.sisa>0)
.forEach(p=>{
pinjamanBayar.innerHTML+=`<option value="${p.id}">${rupiah(p.sisa)}</option>`;
});
}

/* SIMPAN ANGSURAN */
function simpanAngsuran(e){
e.preventDefault();
const db=getDB();
db.transaksi=db.transaksi||[];

const pin=db.pinjaman.find(p=>p.id==pinjamanBayar.value);
pin.sisa-=+jumlahBayar.value;
if(pin.sisa<0) pin.sisa=0;

db.transaksi.push({id:Date.now(),pinjamanId:pin.id,jumlah:+jumlahBayar.value,tanggal:new Date().toISOString().slice(0,10)});
saveDB(db);

formBayar.reset();
loadPinjaman();
alert("Angsuran tersimpan");
}

/* INIT */
loadAnggota();
loadPinjaman();
</script>
</body>
</html>
